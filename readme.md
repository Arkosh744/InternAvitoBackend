# Тестовое задание на стажировку Avito Tech Golang Backend Developer

[Описание задания](https://github.com/avito-tech/internship_backend_2022)

* Задача реализована с помощью фреймворка - Echo
* Выполнялось основываясь на принципах Чистой архитектуры
* Database - PostgreSQL
* Созданы файлы тестов и моков для controller уровня (transport) с использованием go:generate and mockery
* Postman файл с примерами запросов включен в репозиторий
* Конфигурационный env файл обрабатывается с помощью viper
* Сгенерирована swagger документация
* Для запуска используется docker-compose

### Запуск

Для запуска необходимо создать локальный app.env @ ./configs/app.env файл и затем выполнить в терминале:

```bash
make run
```

или

```bash
docker compose --env-file .\configs\app.env up --build wallet-app
```

_____________________________________________________________

# Реализовано:

1) Метод начисления средств на баланс.
    - Принимает id пользователя / id кошелька / email и сколько средств зачислить.
    - Возвращает message с email; balance.
2) Метод получения баланса по id пользователя.
    - Принимает id пользователя.
    - Возвращает message с email; balance.
3) Метод перевод средств от пользователя к пользователю.
    - Принимает id пользователя, от которого переводятся средства; id пользователя, которому переводятся средства;
      количество средст.
    - Возвращает message.
4) Метод резервирования средств с основного баланса на отдельном счете - реализован как метод оформления заказа на
   покупку услуги.
    - Принимает id пользователя, название услуги, сумму платежа.
    - Возвращает message и order_id.
5) Метод признания выручки - реализован как <br>
   5.1) метод подтверждения заказа на покупку услуги <br>
   5.2) отклонения заказа (и возвращение средств на основной баланс кошелька пользователя - разрезервирование средств
   пользователя).
    - Принимает user_id, order_id.
    - Возвращает message.

Дополнительные задания:

1) Метод получения отчета для бухгалетрии.
    - Принимает цифру месяца и года.
    - Возвращает message с месяцем и годом; report: array с операциями с суммами по каждому сервису.
    - TODO: Реализовать выдачу csv-файла в виде ссылки (s3)
2) Реализован метод получения списка транзакций пользователя по его id
    - Принимает id пользователя, limit, offset (параметры для пагинации), sort_field(по какому полю сортируем), order(
      порядок сортировки - ASC / DESC).
    - Возвращает message с user id и report со списком транзакций пользователя согласно критериям.

# SWAGGER

Swagger docs
Чтобы обновить документацию используем: swag init -g cmd/server/main.go

Доступен по адресу: http://localhost:8080/swagger/index.html

Пример реализации
![img.png](misc_files/img.png)

# Вопросы:

1) По умолчанию сервис не содержит в себе никаких данных о балансах (пустая табличка в БД). Данные о балансе появляются
   при первом зачислении денег.
    - При создании пользователя сервиса у него нет кошелька, кошелек создается при первом зачислении денег на счет -
      создается кошелек с 0 балансом и следующим запросом баланс пополняется на указанную сумму.
    - Можно оптимизировать - делать все сразу в 1 запросе, но пока оставил такую реализацию, т.к. пользователь может
      зарегистрироваться, но не пользоваться услугами, т.е. не иметь кошелька.
2) Во всех методах, которые идентифицируют пользователей, оставил только ид пользователя, кроме метода начисления
   средств, с целью уменьшения количества кода, но реализация показана :)
3) В идеале для метода "3) перевод средст между пользователями" нужна авторизация у того, кто переводит деньги, но в
   задании
   не было указано, что нужна авторизация, поэтому принял, что приходят запросы из другой системы, где пользователь уже
   авторизован и мы выполняем запросы от его имени.
4) Есть следующая формулировка "Для этого у нас есть специальный сервис управления услугами, который перед применением
   услуги резервирует деньги на отдельном счете и потом списывает в доход компании."
    - Сделал так, что при оформлении заказа на покупку услуги, средства переносятся с баланса на "удерживаемые" средства
      кошелька пользователя до того момента, пока не будет закрыт заказ (успех - списываются и переводятся продавцу,
      отказ -
      возвращаются пользователю).
5) Для доп.задания с отчетом решил, что не стоит делать отдельной таблицы и достаточно таблицы с транзакциями и
   фильтрацией по комментариям транзакций. Все транзакции с комментарием "income from..." - это получение прибыли с
   продажи услуг, т.е. можно их просто просуммировать.
6) Заранее предопределил 3 услуги, метод добавления новых услуг не реализовывал.
